<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in h√†ng ng√†y - FourT MIDI Community</title>
    <link rel="icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/community/community.css">
</head>

<body>
    <div class="bg-wrapper">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    <div class="grid-overlay"></div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="/favicon.ico" alt="FourT" class="nav-logo-img">
                <span>FourT MIDI</span>
            </a>
            <div class="nav-links">
                <a href="/community" class="nav-link">üéµ Kh√°m ph√°</a>
                <a href="/community/leaderboard" class="nav-link">üèÜ B·∫£ng x·∫øp h·∫°ng</a>
                <a href="/community/upload" class="nav-link">‚¨ÜÔ∏è Upload</a>
            </div>
            <div class="nav-user" id="nav-user">
                <div class="user-points" id="user-points">üí∞ 0 pts</div>
                <div class="user-avatar" onclick="toggleUserMenu()">
                    <span id="user-initial">U</span>
                </div>
                <div class="user-menu" id="user-menu">
                    <a href="/community/profile" class="user-menu-item">üë§ H·ªì s∆°</a>
                    <a href="/community/my-midi" class="user-menu-item">üéµ MIDI c·ªßa t√¥i</a>
                    <a href="/community/downloads" class="user-menu-item">üì• ƒê√£ t·∫£i</a>
                    <a href="/community/checkin" class="user-menu-item active">‚ú® Check-in</a>
                    <hr>
                    <a href="#" class="user-menu-item logout" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="community-hero" style="padding-bottom: 20px;">
                <h1 class="hero-title">
                    <span class="title-icon">‚ú®</span>
                    <span class="text-gradient">Check-in</span>
                </h1>
                <p class="hero-subtitle">ƒêi·ªÉm danh m·ªói ng√†y ƒë·ªÉ nh·∫≠n ƒëi·ªÉm th∆∞·ªüng!</p>
            </section>

            <section class="checkin-container">
                <div class="checkin-card">
                    <div class="streak-display">
                        <div class="streak-number" id="streak-number">0</div>
                        <div class="streak-label">Ng√†y li√™n ti·∫øp üî•</div>
                    </div>

                    <div class="checkin-info">
                        <div class="checkin-reward">
                            <span class="reward-label">Ph·∫ßn th∆∞·ªüng h√¥m nay</span>
                            <span class="reward-value" id="reward-value">+2 ƒëi·ªÉm</span>
                        </div>
                        <p class="checkin-note">Streak c√†ng cao, ph·∫ßn th∆∞·ªüng c√†ng l·ªõn!</p>
                    </div>

                    <button class="btn btn-primary btn-full btn-large" id="checkin-btn" onclick="doCheckin()">
                        ‚ú® ƒêi·ªÉm danh ngay
                    </button>

                    <div class="checkin-done" id="checkin-done" style="display: none;">
                        <div class="done-icon">‚úÖ</div>
                        <h3>ƒê√£ ƒëi·ªÉm danh h√¥m nay!</h3>
                        <p>Quay l·∫°i v√†o ng√†y mai ƒë·ªÉ ti·∫øp t·ª•c streak</p>
                    </div>
                </div>

                <div class="streak-rewards">
                    <h3>üéÅ B·∫£ng ph·∫ßn th∆∞·ªüng Streak</h3>
                    <div class="rewards-table">
                        <div class="reward-row">
                            <span>1-6 ng√†y</span><span>+2 ƒëi·ªÉm</span>
                        </div>
                        <div class="reward-row">
                            <span>7 ng√†y (1 tu·∫ßn)</span><span>+5 ƒëi·ªÉm üéâ</span>
                        </div>
                        <div class="reward-row">
                            <span>8-29 ng√†y</span><span>+3 ƒëi·ªÉm</span>
                        </div>
                        <div class="reward-row special">
                            <span>30 ng√†y (1 th√°ng)</span><span>+15 ƒëi·ªÉm üèÜ</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <script src="/community/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/community';
                return;
            }
            await checkAuth();
            updateCheckinUI();
        });

        function updateCheckinUI() {
            if (!currentUser) return;

            // Use checkin_streak instead of daily_streak
            const streak = currentUser.checkin_streak || 0;
            document.getElementById('streak-number').textContent = streak;

            // Calculate next reward (same logic as backend)
            // Next check-in will be streak + 1
            const nextStreak = streak + 1;
            let reward;
            if (nextStreak === 7) {
                reward = 5;
            } else if (nextStreak === 30) {
                reward = 15;
            } else if (nextStreak > 7) {
                reward = 3;
            } else {
                reward = 2;
            }

            document.getElementById('reward-value').textContent = `+${reward} ƒëi·ªÉm`;

            // Check if already checked in today
            if (currentUser.last_checkin) {
                const lastCheckin = new Date(currentUser.last_checkin);
                const today = new Date();
                if (lastCheckin.toDateString() === today.toDateString()) {
                    showAlreadyCheckedIn();
                }
            }
        }

        function showAlreadyCheckedIn() {
            document.getElementById('checkin-btn').style.display = 'none';
            document.getElementById('checkin-done').style.display = 'block';
        }

        async function doCheckin() {
            const btn = document.getElementById('checkin-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang ƒëi·ªÉm danh...';

            try {
                const response = await fetchWithAuth('/auth/checkin', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast(`‚ú® ƒêi·ªÉm danh th√†nh c√¥ng! +${data.points_earned} ƒëi·ªÉm`, 'success');
                    showAlreadyCheckedIn();
                    document.getElementById('streak-number').textContent = data.new_streak;
                    // Update points display
                    await checkAuth();
                } else {
                    if (data.detail?.includes('already')) {
                        showToast('B·∫°n ƒë√£ ƒëi·ªÉm danh h√¥m nay r·ªìi!', 'info');
                        showAlreadyCheckedIn();
                    } else {
                        showToast(data.detail || 'L·ªói ƒëi·ªÉm danh', 'error');
                    }
                }
            } catch (error) {
                showToast('L·ªói k·∫øt n·ªëi', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® ƒêi·ªÉm danh ngay';
            }
        }
    </script>

    <style>
        .checkin-container {
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 60px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .checkin-card,
        .streak-rewards {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
        }

        .streak-display {
            margin-bottom: 32px;
        }

        .streak-number {
            font-size: 72px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .streak-label {
            font-size: 18px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .checkin-info {
            margin-bottom: 32px;
        }

        .checkin-reward {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .reward-label {
            color: var(--text-secondary);
        }

        .reward-value {
            font-weight: 700;
            color: #22c55e;
            font-size: 18px;
        }

        .checkin-note {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .btn-large {
            padding: 18px;
            font-size: 18px;
        }

        .checkin-done {
            padding: 24px;
        }

        .done-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .checkin-done h3 {
            color: #22c55e;
            margin-bottom: 8px;
        }

        .checkin-done p {
            color: var(--text-secondary);
        }

        .streak-rewards h3 {
            margin-bottom: 20px;
            text-align: left;
        }

        .rewards-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reward-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            font-size: 14px;
        }

        .reward-row.special {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .reward-row span:last-child {
            font-weight: 600;
            color: #22c55e;
        }
    </style>
</body>

</html>